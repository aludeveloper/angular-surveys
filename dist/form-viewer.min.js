angular.module("mwFormViewer",["ngSanitize","ui.bootstrap","ng-sortable","pascalprecht.translate"]),angular.module("mwFormViewer").directive("mwPriorityList",function(){return{replace:!0,restrict:"AE",require:"^mwFormQuestion",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?"},templateUrl:"mw-priority-list.html",controllerAs:"ctrl",bindToController:!0,controller:function(){function e(e){if(e)for(var t=0;t<e.length;t++){var n=e[t];n.priority=t+1}}function t(e){e.sort(function(e,t){return e.priority-t.priority})}var n=this;this.$onInit=function(){n.questionResponse.priorityList||(n.questionResponse.priorityList=[]),n.idToItem={},t(n.questionResponse.priorityList),n.availableItems=[],n.question.priorityList.forEach(function(e){n.idToItem[e.id]=e;var t=n.questionResponse.priorityList.some(function(t){return e.id==t.id});t||n.availableItems.push({priority:null,id:e.id})}),n.allItemsOrdered=0==n.availableItems.length||null;var i={disabled:n.readOnly,ghostClass:"beingDragged"};n.orderedConfig=angular.extend({},i,{group:{name:"A",pull:!1,put:["B"]},onEnd:function(t,i){e(n.questionResponse.priorityList)}}),n.availableConfig=angular.extend({},i,{sort:!1,group:{name:"B",pull:["A"],put:!1},onEnd:function(t,i){e(n.questionResponse.priorityList),n.allItemsOrdered=0==n.availableItems.length||null}})},1===angular.version.major&&angular.version.minor<5&&this.$onInit()},link:function(e,t,n,i){var o=e.ctrl;o.print=i.print}}}),angular.module("mwFormViewer").directive("mwFormViewer",["$rootScope",function(e){return{replace:!0,restrict:"AE",scope:{formData:"=",responseData:"=",templateData:"=?",readOnly:"=?",options:"=?",formStatus:"=?",onSubmit:"&",onSave:"&",onBack:"&",api:"=?"},templateUrl:"mw-form-viewer.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","$interpolate",function(t,n){function i(){o.formData.pages.sort(function(e,t){return e.number-t.number})}var o=this,s=e;o.largeFileFlag=!1,o.invalidPhone=!1,e.$on("fileRequiredFlag",function(e,t){o.largeFileFlag=t}),o.$onInit=function(){o.defaultOptions={nestedForm:!1,autoStart:!1,disableSubmit:!1},o.options=angular.extend({},o.defaultOptions,o.options),o.submitStatus="NOT_SUBMITTED",o.formSubmitted=!1,e.$on("invalidPhoneFlag",function(e,t){o.invalidPhone=t}),i(),o.pageIdToPage={},o.formData.pages.forEach(function(e){o.pageIdToPage[e.id]=e}),o.buttons={prevPage:{visible:!1,disabled:!1},nextPage:{visible:!1,disabled:!1},submitForm:{visible:!1,disabled:!1}},s.submitButton=o.buttons.submitForm.visible,s.formValid=o.form,o.resetPages(),o.api&&(o.api.reset=function(){for(var e in o.responseData)o.responseData.hasOwnProperty(e)&&delete o.responseData[e];o.buttons.submitForm.visible=!1,s.submitButton=o.buttons.submitForm.visible,s.formValid=o.form,o.buttons.prevPage.visible=!1,o.buttons.nextPage.visible=!1,o.currentPage=null,t(o.resetPages,0)})},o.submitForm=function(){o.formSubmitted=!0,o.submitStatus="IN_PROGRESS",o.setCurrentPage(null);var e=o.onSubmit();e.then(function(){o.submitStatus="SUCCESS"})["catch"](function(){o.submitStatus="ERROR"})},o.submitValid=function(){return o.options.disableSubmit||o.form.$invalid||o.largeFileFlag||o.invalidPhone?(localStorage.setItem("submitValid",!0),!0):(localStorage.setItem("submitValid",!1),!1)},o.setCurrentPage=function(t){return o.currentPage=t,t?(o.setDefaultNextPage(),void o.initResponsesForCurrentPage()):(o.buttons.submitForm.visible=!1,e.submitButton=o.buttons.submitForm.visible,e.formValid=o.form,o.buttons.prevPage.visible=!1,void(o.buttons.nextPage.visible=!1))},o.setDefaultNextPage=function(){var t=o.formData.pages.indexOf(o.currentPage);if(o.currentPage.isFirst=0==t,o.currentPage.isLast=t==o.formData.pages.length-1,o.buttons.submitForm.visible=o.currentPage.isLast,e.submitButton=o.buttons.submitForm.visible,e.formValid=o.form,o.buttons.prevPage.visible=!o.currentPage.isFirst,o.buttons.nextPage.visible=!o.currentPage.isLast,o.currentPage.isLast?o.nextPage=null:o.nextPage=o.formData.pages[t+1],o.currentPage.pageFlow){var n=!1;o.currentPage.pageFlow.formSubmit?(o.nextPage=null,n=!0):o.currentPage.pageFlow.page?(o.nextPage=o.pageIdToPage[o.currentPage.pageFlow.page.id],o.buttons.nextPage.visible=!0):o.currentPage.isLast&&(o.nextPage=null,n=!0),o.buttons.submitForm.visible=n,e.submitButton=o.buttons.submitForm.visible,e.formValid=o.form,o.buttons.nextPage.visible=!n}},o.initResponsesForCurrentPage=function(){o.currentPage.elements.forEach(function(e){var t=e.question;t&&!o.responseData[t.id]&&(o.responseData[t.id]={})})},o.beginResponse=function(){o.formData.pages.length>0&&(o.setCurrentPage(o.formData.pages[0]),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:o.currentPage}))},o.resetPages=function(){o.prevPages=[],o.currentPage=null,o.nextPage=null,o.formSubmitted=!1,o.options.autoStart&&o.beginResponse()},o.goToPrevPage=function(){window.scrollTo(0,0),o.onBack();var t=o.prevPages.pop();o.setCurrentPage(t),o.updateNextPageBasedOnAllAnswers(),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:o.currentPage})},o.goToNextPage=function(){window.scrollTo(0,0),o.onSave(),o.prevPages.push(o.currentPage),o.updateNextPageBasedOnAllAnswers(),o.setCurrentPage(o.nextPage),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:o.currentPage})},o.updateNextPageBasedOnAllAnswers=function(){o.currentPage.elements.forEach(function(e){o.updateNextPageBasedOnPageElementAnswers(e)}),o.buttons.submitForm.visible=!o.nextPage,e.submitButton=o.buttons.submitForm.visible,e.formValid=o.form,o.buttons.nextPage.visible=!!o.nextPage},o.updateNextPageBasedOnPageElementAnswers=function(e){var t=e.question;t&&t.pageFlowModifier&&t.offeredAnswers.forEach(function(e){e.pageFlow&&o.responseData[t.id].selectedAnswer==e.id&&(e.pageFlow.formSubmit?o.nextPage=null:e.pageFlow.page&&(o.nextPage=o.pageIdToPage[e.pageFlow.page.id]))})},o.onResponseChanged=function(t){o.setDefaultNextPage(),e.$broadcast("mwForm.pageEvents.formSubmitValid",{formSubmitValid:o.form}),o.updateNextPageBasedOnAllAnswers()},o.print=function(e){return e&&o.templateData?n(e)(o.templateData):e},1===angular.version.major&&angular.version.minor<5&&o.$onInit()}],link:function(t,n,i){var o=t.ctrl;o.formStatus&&(o.formStatus.form=o.form),t.$on("mwForm.pageEvents.changePage",function(t,n){if("undefined"!=typeof n.page&&n.page<o.formData.pages.length){o.resetPages();for(var i=0;i<n.page;i++)o.prevPages.push(o.formData.pages[i]);var s=o.formData.pages[n.page];o.setCurrentPage(s),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:s}),o.updateNextPageBasedOnAllAnswers()}})}}}]),angular.module("mwFormViewer").factory("FormQuestionId",function(){var e=0;return{next:function(){return++e}}}),angular.module("mwFormViewer").directive("mwFormQuestion",["$parse","$rootScope",function(e,t){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?",onResponseChanged:"&?"},templateUrl:"mw-form-question.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","FormQuestionId",function(e,n){var i=this;i.largeFileFlag=!1,i.fileSelectedEvent=!1,i.invalidPhone=!1,i.today=new Date,this.$onInit=function(){i.id=n.next(),"radio"==i.question.type?i.questionResponse.other&&(i.isOtherAnswer=!0):"checkbox"==i.question.type?(i.questionResponse.selectedAnswers&&i.questionResponse.selectedAnswers.length?i.selectedAnswer=!0:i.questionResponse.selectedAnswers=[],i.questionResponse.other&&(i.isOtherAnswer=!0)):"grid"==i.question.type?i.question.grid.cellInputType||(i.question.grid.cellInputType="radio"):"division"==i.question.type?(i.computeDivisionSum=function(){i.divisionSum=0,i.question.divisionList.forEach(function(e){0==i.questionResponse[e.id]||i.questionResponse[e.id]?i.divisionSum+=i.questionResponse[e.id]:(i.questionResponse[e.id]=null,i.divisionSum+=0)})},i.computeDivisionSum()):"date"==i.question.type||"datetime"==i.question.type||"time"==i.question.type?i.questionResponse.answer&&(i.questionResponse.answer=new Date(i.questionResponse.answer)):"file"==i.question.type&&(i.questionResponse.fileName=i.questionResponse.fileName_1,i.questionResponse.answer=i.questionResponse.answer),i.isAnswerSelected=!1,i.initialized=!0},i.mappingTelephoneQuestion=function(n){e(function(){if("telephone"==n.type){var e="#"+n.id+"phone",o="#"+n.id+"error-msg",s="#"+n.id+"valid-msg",r=$(e),a=$(o),u=$(s);void 0,r.intlTelInput({initialCountry:"auto",geoIpLookup:function(e){$.get("https://ipinfo.io",function(){},"jsonp").always(function(t){var n=t&&t.country?t.country:"";e(n)})},utilsScript:"../bower_components/intl-tel-input/build/js/utils.js"});var l=function(){r.removeClass("error"),a.addClass("hide"),u.addClass("hide")};r.blur(function(){l(),$.trim(r.val())&&(r.intlTelInput("isValidNumber")?(i.invalidPhone=!1,t.$broadcast("invalidPhoneFlag",i.invalidPhone),u.removeClass("hide")):(i.invalidPhone=!0,t.$broadcast("invalidPhoneFlag",i.invalidPhone),r.addClass("error"),a.removeClass("hide")))}),r.on("keyup change",l),$(e).on("countrychange",function(e,t){void 0,i.questionResponse.countryCode=t.dialCode})}},3e3)},i.initQuestionsView=function(e){void 0,i.mappingTelephoneQuestion(e)},i.textareaChanged=function(){delete i.questionResponse.other,i.isOtherAnswer=!1,i.answerChanged()},i.selectedAnswerChanged=function(){delete i.questionResponse.other,i.isOtherAnswer=!1,i.answerChanged()},i.otherAnswerRadioChanged=function(){i.isOtherAnswer&&(i.questionResponse.selectedAnswer=null),i.answerChanged()},i.otherAnswerCheckboxChanged=function(){i.isOtherAnswer||delete i.questionResponse.other,i.selectedAnswer=!(!i.questionResponse.selectedAnswers.length&&!i.isOtherAnswer)||null,i.answerChanged()},i.toggleSelectedAnswer=function(e){i.questionResponse.selectedAnswers.indexOf(e.id)===-1?i.questionResponse.selectedAnswers.push(e.id):i.questionResponse.selectedAnswers.splice(i.questionResponse.selectedAnswers.indexOf(e.id),1),i.selectedAnswer=!(!i.questionResponse.selectedAnswers.length&&!i.isOtherAnswer)||null,i.answerChanged()},i.answerChanged=function(){i.onResponseChanged&&i.onResponseChanged()},1===angular.version.major&&angular.version.minor<5&&this.$onInit()}],link:function(e,n,i,o){var s=e.ctrl;s.print=o.print,n.bind("change",function(n){var i=n.target.files[0].size/4096;if(void 0,i<=1024){s.fileSelectedEvent=!0,s.largeFileFlag=!1,t.$broadcast("fileRequiredFlag",s.largeFileFlag);var o=new FileReader;n.target.files[0];o.onload=function(t){e.$apply(function(){s.questionResponse.answer=t.target.result,s.questionResponse.fileName=n.target.files[0].name})},o.readAsDataURL(n.target.files[0])}else s.largeFileFlag=!0,t.$broadcast("fileRequiredFlag",s.largeFileFlag),void 0})}}}]),angular.module("mwFormViewer").directive("mwFormConfirmationPage",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{submitStatus:"=",confirmationMessage:"=",readOnly:"=?"},templateUrl:"mw-form-confirmation-page.html",controllerAs:"ctrl",bindToController:!0,controller:function(){},link:function(e,t,n,i){var o=e.ctrl;o.print=i.print}}});