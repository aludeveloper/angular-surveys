angular.module("mwFormViewer",["ngSanitize","ui.bootstrap","ng-sortable","pascalprecht.translate","ngCookies"]),angular.module("mwFormViewer").directive("mwPriorityList",function(){return{replace:!0,restrict:"AE",require:"^mwFormQuestion",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?"},templateUrl:"mw-priority-list.html",controllerAs:"ctrl",bindToController:!0,controller:function(){function e(e){if(e)for(var t=0;t<e.length;t++){var n=e[t];n.priority=t+1}}function t(e){e.sort(function(e,t){return e.priority-t.priority})}var n=this;this.$onInit=function(){n.questionResponse.priorityList||(n.questionResponse.priorityList=[]),n.idToItem={},t(n.questionResponse.priorityList),n.availableItems=[],n.question.priorityList.forEach(function(e){n.idToItem[e.id]=e;var t=n.questionResponse.priorityList.some(function(t){return e.id==t.id});t||n.availableItems.push({priority:null,id:e.id})}),n.allItemsOrdered=0==n.availableItems.length||null;var o={disabled:n.readOnly,ghostClass:"beingDragged"};n.orderedConfig=angular.extend({},o,{group:{name:"A",pull:!1,put:["B"]},onEnd:function(t,o){e(n.questionResponse.priorityList)}}),n.availableConfig=angular.extend({},o,{sort:!1,group:{name:"B",pull:["A"],put:!1},onEnd:function(t,o){e(n.questionResponse.priorityList),n.allItemsOrdered=0==n.availableItems.length||null}})},1===angular.version.major&&angular.version.minor<5&&this.$onInit()},link:function(e,t,n,o){var i=e.ctrl;i.print=o.print}}}),angular.module("mwFormViewer").directive("mwFormViewer",["$rootScope",function(e){return{replace:!0,restrict:"AE",scope:{formData:"=",responseData:"=",templateData:"=?",readOnly:"=?",options:"=?",formStatus:"=?",onSubmit:"&",onSave:"&",onBack:"&",api:"=?"},templateUrl:"mw-form-viewer.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","$interpolate","$cookies",function(t,n,o){function i(){s.formData.pages.sort(function(e,t){return e.number-t.number})}var s=this,r=e;s.largeFileFlag=!1,s.invalidPhone=!1,e.$on("fileRequiredFlag",function(e,t){s.largeFileFlag=t}),s.$onInit=function(){s.defaultOptions={nestedForm:!1,autoStart:!1,disableSubmit:!1},s.options=angular.extend({},s.defaultOptions,s.options),s.submitStatus="NOT_SUBMITTED",s.formSubmitted=!1,e.$on("invalidPhoneFlag",function(e,t){s.invalidPhone=t}),i(),s.pageIdToPage={},s.formData.pages.forEach(function(e){s.pageIdToPage[e.id]=e}),s.buttons={prevPage:{visible:!1,disabled:!1},nextPage:{visible:!1,disabled:!1},submitForm:{visible:!1,disabled:!1}},r.submitButton=s.buttons.submitForm.visible,r.formValid=s.form,s.resetPages(),s.api&&(s.api.reset=function(){for(var e in s.responseData)s.responseData.hasOwnProperty(e)&&delete s.responseData[e];s.buttons.submitForm.visible=!1,r.submitButton=s.buttons.submitForm.visible,r.formValid=s.form,s.buttons.prevPage.visible=!1,s.buttons.nextPage.visible=!1,s.currentPage=null,t(s.resetPages,0)})},s.submitForm=function(){s.formSubmitted=!0,s.submitStatus="IN_PROGRESS",s.setCurrentPage(null);var e=s.onSubmit();e.then(function(){s.submitStatus="SUCCESS"})["catch"](function(){s.submitStatus="ERROR"})},s.submitValid=function(){return s.options.disableSubmit||s.form.$invalid||s.largeFileFlag||s.invalidPhone?(localStorage.setItem("submitValid",!0),!0):(localStorage.setItem("submitValid",!1),!1)},s.setCurrentPage=function(t){return s.currentPage=t,t?(s.setDefaultNextPage(),void s.initResponsesForCurrentPage()):(s.buttons.submitForm.visible=!1,e.submitButton=s.buttons.submitForm.visible,e.formValid=s.form,s.buttons.prevPage.visible=!1,void(s.buttons.nextPage.visible=!1))},s.getSfFlagValue=function(){var e;angular.forEach(s.formData.pages,function(t,n){angular.forEach(t.elements,function(t,n){t.selecteditem&&t.selecteditem.sfkey&&"paragraphcondition"==t.type&&(e=t.selecteditem.sfkey.key)})});var t,n,i=localStorage.getItem("auth_token"),r=__env.apiUrl,a=JSON.parse(o.get("userInfo")),l=a.applicationIdMap,u=localStorage.getItem("applicationName");angular.forEach(l,function(e,t){u=t,n=e}),""!=e&&void 0!=e&&""!=u&&void 0!=u&&$.ajax({async:!1,headers:{"X-AUTH-TOKEN":i,"content-Type":"Application/Json"},url:r+"/salesforce/conditionalpara/"+e+"/"+u+"/"+a.email,success:function(e){void 0,t=e}}),s.sfFlag=t,"Pass"==s.sfFlag?s.condtionalParaFlag=!0:s.condtionalParaFlag=!1},s.setDefaultNextPage=function(){var t=s.formData.pages.indexOf(s.currentPage);if(s.currentPage.isFirst=0==t,s.currentPage.isLast=t==s.formData.pages.length-1,s.buttons.submitForm.visible=s.currentPage.isLast,e.submitButton=s.buttons.submitForm.visible,e.formValid=s.form,s.buttons.prevPage.visible=!s.currentPage.isFirst,s.buttons.nextPage.visible=!s.currentPage.isLast,s.currentPage.isLast?s.nextPage=null:s.nextPage=s.formData.pages[t+1],s.currentPage.pageFlow){var n=!1;s.currentPage.pageFlow.formSubmit?(s.nextPage=null,n=!0):s.currentPage.pageFlow.page?(s.nextPage=s.pageIdToPage[s.currentPage.pageFlow.page.id],s.buttons.nextPage.visible=!0):s.currentPage.isLast&&(s.nextPage=null,n=!0),s.buttons.submitForm.visible=n,e.submitButton=s.buttons.submitForm.visible,e.formValid=s.form,s.buttons.nextPage.visible=!n}},s.initResponsesForCurrentPage=function(){s.currentPage.elements.forEach(function(e){var t=e.question;t&&!s.responseData[t.id]&&(s.responseData[t.id]={})})},s.beginResponse=function(){s.formData.pages.length>0&&(s.setCurrentPage(s.formData.pages[0]),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:s.currentPage}))},s.resetPages=function(){s.prevPages=[],s.currentPage=null,s.nextPage=null,s.formSubmitted=!1,s.options.autoStart&&s.beginResponse()},s.goToPrevPage=function(){window.scrollTo(0,0),s.onBack();var t=s.prevPages.pop();s.setCurrentPage(t),s.updateNextPageBasedOnAllAnswers(),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:s.currentPage})},s.goToNextPage=function(){window.scrollTo(0,0),s.onSave(),s.prevPages.push(s.currentPage),s.updateNextPageBasedOnAllAnswers(),s.setCurrentPage(s.nextPage),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:s.currentPage})},s.updateNextPageBasedOnAllAnswers=function(){s.currentPage.elements.forEach(function(e){s.updateNextPageBasedOnPageElementAnswers(e)}),s.buttons.submitForm.visible=!s.nextPage,e.submitButton=s.buttons.submitForm.visible,e.formValid=s.form,s.buttons.nextPage.visible=!!s.nextPage},s.updateNextPageBasedOnPageElementAnswers=function(e){var t=e.question;t&&t.pageFlowModifier&&t.offeredAnswers.forEach(function(e){e.pageFlow&&s.responseData[t.id].selectedAnswer==e.id&&(e.pageFlow.formSubmit?s.nextPage=null:e.pageFlow.page&&(s.nextPage=s.pageIdToPage[e.pageFlow.page.id]))})},s.onResponseChanged=function(t){s.setDefaultNextPage(),e.$broadcast("mwForm.pageEvents.formSubmitValid",{formSubmitValid:s.form}),s.updateNextPageBasedOnAllAnswers()},s.print=function(e){return e&&s.templateData?n(e)(s.templateData):e},1===angular.version.major&&angular.version.minor<5&&s.$onInit()}],link:function(t,n,o){var i=t.ctrl;i.formStatus&&(i.formStatus.form=i.form),t.$on("mwForm.pageEvents.changePage",function(t,n){if("undefined"!=typeof n.page&&n.page<i.formData.pages.length){i.resetPages();for(var o=0;o<n.page;o++)i.prevPages.push(i.formData.pages[o]);var s=i.formData.pages[n.page];i.setCurrentPage(s),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:s}),i.updateNextPageBasedOnAllAnswers()}})}}}]),angular.module("mwFormViewer").factory("FormQuestionId",function(){var e=0;return{next:function(){return++e}}}),angular.module("mwFormViewer").directive("mwFormQuestion",["$parse","$rootScope",function(e,t){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?",onResponseChanged:"&?"},templateUrl:"mw-form-question.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","FormQuestionId",function(e,n){var o=this;o.largeFileFlag=!1,o.fileSelectedEvent=!1,o.invalidPhone=!1,o.today=new Date,this.$onInit=function(){o.id=n.next(),"radio"==o.question.type?o.questionResponse.other&&(o.isOtherAnswer=!0):"checkbox"==o.question.type?(o.questionResponse.selectedAnswers&&o.questionResponse.selectedAnswers.length?o.selectedAnswer=!0:o.questionResponse.selectedAnswers=[],o.questionResponse.other&&(o.isOtherAnswer=!0)):"grid"==o.question.type?o.question.grid.cellInputType||(o.question.grid.cellInputType="radio"):"division"==o.question.type?(o.computeDivisionSum=function(){o.divisionSum=0,o.question.divisionList.forEach(function(e){0==o.questionResponse[e.id]||o.questionResponse[e.id]?o.divisionSum+=o.questionResponse[e.id]:(o.questionResponse[e.id]=null,o.divisionSum+=0)})},o.computeDivisionSum()):"date"==o.question.type||"datetime"==o.question.type||"time"==o.question.type?o.questionResponse.answer&&(o.questionResponse.answer=new Date(o.questionResponse.answer)):"file"==o.question.type&&(o.questionResponse.fileName=o.questionResponse.fileName_1,o.questionResponse.answer=o.questionResponse.answer),o.isAnswerSelected=!1,o.initialized=!0},o.mappingTelephoneQuestion=function(n){e(function(){if("telephone"==n.type){var e="#"+n.id+"phone",i="#"+n.id+"error-msg",s="#"+n.id+"valid-msg",r=$(e),a=$(i),l=$(s);void 0,r.intlTelInput({initialCountry:"auto",geoIpLookup:function(e){$.get("https://ipinfo.io",function(){},"jsonp").always(function(t){var n=t&&t.country?t.country:"";e(n)})},utilsScript:"../bower_components/intl-tel-input/build/js/utils.js"});var u=function(){r.removeClass("error"),a.addClass("hide"),l.addClass("hide")};r.blur(function(){u(),$.trim(r.val())&&(r.intlTelInput("isValidNumber")?(o.invalidPhone=!1,t.$broadcast("invalidPhoneFlag",o.invalidPhone),l.removeClass("hide")):(o.invalidPhone=!0,t.$broadcast("invalidPhoneFlag",o.invalidPhone),r.addClass("error"),a.removeClass("hide")))}),r.on("keyup change",u),$(e).on("countrychange",function(e,t){void 0,o.questionResponse.countryCode=t.dialCode})}},3e3)},o.initQuestionsView=function(e){void 0,o.mappingTelephoneQuestion(e)},o.textareaChanged=function(){delete o.questionResponse.other,o.isOtherAnswer=!1,o.answerChanged()},o.selectedAnswerChanged=function(){delete o.questionResponse.other,o.isOtherAnswer=!1,o.answerChanged()},o.otherAnswerRadioChanged=function(){o.isOtherAnswer&&(o.questionResponse.selectedAnswer=null),o.answerChanged()},o.otherAnswerCheckboxChanged=function(){o.isOtherAnswer||delete o.questionResponse.other,o.selectedAnswer=!(!o.questionResponse.selectedAnswers.length&&!o.isOtherAnswer)||null,o.answerChanged()},o.toggleSelectedAnswer=function(e){o.questionResponse.selectedAnswers.indexOf(e.id)===-1?o.questionResponse.selectedAnswers.push(e.id):o.questionResponse.selectedAnswers.splice(o.questionResponse.selectedAnswers.indexOf(e.id),1),o.selectedAnswer=!(!o.questionResponse.selectedAnswers.length&&!o.isOtherAnswer)||null,o.answerChanged()},o.answerChanged=function(){o.onResponseChanged&&o.onResponseChanged()},1===angular.version.major&&angular.version.minor<5&&this.$onInit()}],link:function(e,n,o,i){var s=e.ctrl;s.print=i.print,n.bind("change",function(n){var o=n.target.files[0].size/4096;if(void 0,o<=1024){s.fileSelectedEvent=!0,s.largeFileFlag=!1,t.$broadcast("fileRequiredFlag",s.largeFileFlag);var i=new FileReader;n.target.files[0];i.onload=function(t){e.$apply(function(){s.questionResponse.answer=t.target.result,s.questionResponse.fileName=n.target.files[0].name})},i.readAsDataURL(n.target.files[0])}else s.largeFileFlag=!0,t.$broadcast("fileRequiredFlag",s.largeFileFlag),void 0})}}}]),angular.module("mwFormViewer").directive("mwFormConfirmationPage",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{submitStatus:"=",confirmationMessage:"=",readOnly:"=?"},templateUrl:"mw-form-confirmation-page.html",controllerAs:"ctrl",bindToController:!0,controller:function(){},link:function(e,t,n,o){var i=e.ctrl;i.print=o.print}}});